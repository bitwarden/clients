default_platform(:mac)

# Static configuration for the Mac desktop app
require 'json'

# Read App Store Connect supported locales from electron-builder.json
def load_app_store_locales
  config_path = File.expand_path("../electron-builder.json", __dir__)
  config = JSON.parse(File.read(config_path))
  bundle_localizations = config.dig("mac", "extendInfo", "CFBundleLocalizations") || []
  
  # Convert to App Store Connect locale format
  bundle_localizations.map do |locale|
    case locale
    when "en" then "en-US"  # App Store requires en-US format
    else locale  # Others should match (pt-BR, zh-Hans, etc.)
    end
  end.sort
end

APP_CONFIG = {
  app_identifier: "com.bitwarden.desktop",
  release_notes_path: "fastlane/release_notes",
  locales: load_app_store_locales
}

platform :mac do
  desc "Prepare release notes from changelog"
  lane :prepare_release_notes do |options|
    changelog = options[:changelog] || "Bug fixes and improvements"
    
    # Create release notes for each supported locale
    Dir.chdir("..") do
      APP_CONFIG[:locales].each do |locale|
        locale_dir = "#{APP_CONFIG[:release_notes_path]}/#{locale}"
        FileUtils.mkdir_p(locale_dir)
        
        release_notes_path = "#{locale_dir}/release_notes.txt"
        File.write(release_notes_path, changelog)
        
        UI.message("Created release notes for #{locale}: #{changelog[0,50]}#{changelog.length > 50 ? '...' : ''}")
      end
    end
    
    UI.success("âœ… Prepared release notes for #{APP_CONFIG[:locales].count} locales")
  end

  desc "Validate configuration and parameters"
  lane :validate_config do |options|
    build_number = options[:build_number] || ENV["BUILD_NUMBER"]
    is_dry_run = options[:dry_run] == "true" || options[:dry_run] == true
    
    # Validate required parameters
    UI.user_error!("âŒ BUILD_NUMBER is required") if build_number.nil? || build_number.empty?
    
    # Skip secret validation in dry run mode
    unless is_dry_run
      UI.user_error!("âŒ APP_STORE_CONNECT_TEAM_ISSUER is required") if ENV["APP_STORE_CONNECT_TEAM_ISSUER"].nil?
      UI.user_error!("âŒ APP_STORE_CONNECT_AUTH_KEY is required") if ENV["APP_STORE_CONNECT_AUTH_KEY"].nil?
    end
    
    # Validate build number format (should be numeric)
    UI.user_error!("âŒ BUILD_NUMBER must be numeric, got: #{build_number}") unless build_number.match?(/^\d+$/)
    
    UI.success("âœ… Configuration validation passed")
    UI.message("ðŸ“¦ App ID: #{APP_CONFIG[:app_identifier]}")
    UI.message("ðŸ”¢ Build Number: #{build_number}")
    UI.message("ðŸŒ Locales: #{APP_CONFIG[:locales].count}")
  end

  desc "Publish desktop to the Mac App Store"
  lane :publish do |options|
    build_number = options[:build_number] || ENV["BUILD_NUMBER"]
    changelog = options[:changelog] || "Bug fixes and improvements"
    submit_for_review = options[:submit_for_review] == "true" || options[:submit_for_review] == true
    is_dry_run = options[:dry_run] == "true" || options[:dry_run] == true
    
    if is_dry_run
      UI.header("ðŸ§ª DRY RUN: Testing Bitwarden Desktop App Store submission")
    else
      UI.header("ðŸš€ Publishing Bitwarden Desktop to Mac App Store")
    end
    
    # Validate configuration first
    validate_config(build_number: build_number, dry_run: is_dry_run)
    
    # Prepare release notes for all locales
    prepare_release_notes(changelog: changelog)
    
    if is_dry_run
      UI.important("ðŸ§ª DRY RUN MODE - Skipping actual App Store Connect submission")
      UI.message("âœ… Validation passed")
      UI.message("âœ… Release notes prepared for #{APP_CONFIG[:locales].count} locales")
      UI.message("âœ… Release notes: #{changelog[0,100]}#{changelog.length > 100 ? '...' : ''}")
      UI.success("ðŸŽ¯ DRY RUN COMPLETE - Everything looks ready for production!")
      next # Use 'next' instead of 'return' in fastlane lanes
    end

    # Set up App Store Connect API
    app_store_connect_api_key(
      key_id: "6TV9MKN3GP",
      issuer_id: ENV["APP_STORE_CONNECT_TEAM_ISSUER"],
      key_content: Base64.encode64(ENV["APP_STORE_CONNECT_AUTH_KEY"]),
      is_key_content_base64: true
    )

    # Create release notes hash for all locales
    notes = {}
    APP_CONFIG[:locales].each do |locale|
      release_notes_path = "#{APP_CONFIG[:release_notes_path]}/#{locale}/release_notes.txt"
      if File.exist?(release_notes_path)
        notes[locale] = File.read(release_notes_path)
      end
    end

    # Upload to App Store Connect
    deliver(
      platform: "osx",
      app_identifier: APP_CONFIG[:app_identifier],
      app_version: "2025.7.1", # Hardcoded for testing - TODO: make dynamic
      build_number: build_number,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true, # Skip metadata (managed outside of automation)
      release_notes: notes,
      submit_for_review: submit_for_review,
      phased_release: true, # Enable 7-day phased rollout
      precheck_include_in_app_purchases: false,
      run_precheck_before_submit: false,
      force: true
    )
    
    if submit_for_review
      UI.success("ðŸŽ‰ Successfully submitted Bitwarden Desktop v#{build_number} for App Store review!")
    else
      UI.success("ðŸ“¤ Successfully uploaded Bitwarden Desktop v#{build_number} to App Store Connect")
    end
  end
end
