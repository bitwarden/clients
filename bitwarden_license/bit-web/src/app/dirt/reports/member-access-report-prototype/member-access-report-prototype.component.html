<app-header>
  <bit-search
    [formControl]="searchControl"
    [placeholder]="'searchMembers' | i18n"
    class="tw-grow"
    *ngIf="isComplete"
  ></bit-search>

  <button
    type="button"
    bitButton
    buttonType="secondary"
    (click)="startLoading()"
    *ngIf="isComplete || isError"
  >
    <i class="bwi bwi-refresh" aria-hidden="true"></i>
    Reload
  </button>
</app-header>

<div class="tw-max-w-4xl tw-mb-4">
  <p bitTypography="body1">
    <strong>Prototype:</strong> Member access report using client-side data assembly. This approach
    pivots cipher-access data to member-centric summaries without server-side API calls.
  </p>
</div>

<!-- Loading State -->
<ng-container *ngIf="isLoading">
  <div class="tw-flex-col tw-flex tw-justify-center tw-items-center tw-gap-4 tw-my-8">
    <i class="bwi bwi-2x bwi-spinner bwi-spin tw-text-primary-600" aria-hidden="true"></i>
    <h2 bitTypography="h2">
      <ng-container *ngIf="state === MemberAccessReportState.LoadingCiphers">
        Loading ciphers...
      </ng-container>
      <ng-container *ngIf="state === MemberAccessReportState.ProcessingMembers">
        Processing member access...
      </ng-container>
    </h2>

    <div class="tw-w-full tw-max-w-md">
      <bit-progress [barWidth]="progressPercent"></bit-progress>
      <p class="tw-text-center tw-text-muted tw-mt-2">
        {{ processedCipherCount }} / {{ totalCipherCount }} ciphers processed ({{
          progressPercent
        }}%)
      </p>
    </div>
  </div>
</ng-container>

<!-- Error State -->
<ng-container *ngIf="isError">
  <div
    class="tw-flex-col tw-flex tw-justify-center tw-items-center tw-gap-4 tw-mt-8 tw-p-4 tw-bg-danger-100 tw-rounded"
  >
    <i class="bwi bwi-2x bwi-error tw-text-danger-600" aria-hidden="true"></i>
    <h2 bitTypography="h2" class="tw-text-danger-600">Error Loading Report</h2>
    <p class="tw-text-danger-700">{{ errorMessage }}</p>
  </div>
</ng-container>

<!-- Results -->
<ng-container *ngIf="isComplete">
  <!-- Stats Bar -->
  <div class="tw-flex tw-gap-6 tw-mb-4 tw-p-4 tw-bg-background-alt tw-rounded tw-items-center">
    <div>
      <span class="tw-text-muted">Members:</span>
      <strong class="tw-ml-1">{{ dataSource.data.length }}</strong>
    </div>
    <div>
      <span class="tw-text-muted">Ciphers Processed:</span>
      <strong class="tw-ml-1">{{ totalCipherCount }}</strong>
    </div>
    <div>
      <span class="tw-text-muted">Load Time:</span>
      <strong class="tw-ml-1">{{ loadTimeMs }}ms</strong>
    </div>
  </div>

  <!-- Data Table -->
  <bit-table-scroll [dataSource]="dataSource" [rowSize]="53">
    <ng-container header>
      <th bitCell bitSortable="email" default>Member</th>
      <th bitCell bitSortable="cipherCount" class="tw-w-[150px]">Items</th>
      <th bitCell bitSortable="collectionCount" class="tw-w-[150px]">Collections</th>
      <th bitCell bitSortable="groupCount" class="tw-w-[150px]">Groups</th>
    </ng-container>
    <ng-template bitRowDef let-row let-rowAttr="attr">
      <td
        bitCell
        [attr.data-row-id]="rowAttr"
        class="tw-cursor-pointer"
        (click)="onMemberRowClick(row)"
      >
        <div class="tw-flex tw-items-center">
          <bit-avatar size="small" [text]="row.email" class="tw-mr-3"></bit-avatar>
          <div class="tw-flex tw-flex-col">
            <span class="tw-font-medium">{{ row.name || row.email }}</span>
            <span class="tw-text-sm tw-text-muted" *ngIf="row.name">{{ row.email }}</span>
          </div>
        </div>
      </td>
      <td bitCell class="tw-text-muted tw-cursor-pointer" (click)="onMemberRowClick(row)">
        {{ row.cipherCount }}
      </td>
      <td bitCell class="tw-text-muted tw-cursor-pointer" (click)="onMemberRowClick(row)">
        {{ row.collectionCount }}
      </td>
      <td bitCell class="tw-text-muted tw-cursor-pointer" (click)="onMemberRowClick(row)">
        {{ row.groupCount }}
      </td>
    </ng-template>
  </bit-table-scroll>
</ng-container>
