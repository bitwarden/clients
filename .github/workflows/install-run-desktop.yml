name: Install and Run Desktop client

on:
  workflow_run:
    workflows: ["Build Desktop"]
    types:
      - completed

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  linux-x64-deb:
    name: Install and run Linux x64 .deb
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_sha }}
          persist-credentials: false

      - name: Download deb artifact
        id: download-deb
        uses: bitwarden/gh-actions/download-artifacts@main
        with:
          workflow: build-desktop.yml
          workflow_conclusion: success
          branch: ${{ github.event.workflow_run.head_branch }}
          path: apps/desktop/artifacts/linux/deb/
          artifacts: Bitwarden-*-amd64.deb
          name_is_regexp: true

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install libasound2t64 xvfb
          sudo apt-get install -y xvfb

      - name: Install .deb
        working-directory: ${{ steps.download-deb.outputs.download-path }}
        run: |
          sudo apt-get install -y ./*.deb

      - name: Run .deb
        run: |
          xvfb-run -a bitwarden &
          sleep 30
          if pgrep bitwarden > /dev/null; then
            pkill -9 bitwarden
            echo "Bitwarden is running."
          else
            echo "Bitwarden is not running."
            exit 1
          fi

  linux-x64-appimage:
    name: Install and run Linux x64 appimage
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_sha }}
          persist-credentials: false

      - name: Download appimage artifact
        id: download-appimage
        uses: bitwarden/gh-actions/download-artifacts@main
        with:
          workflow: build-desktop.yml
          workflow_conclusion: success
          branch: ${{ github.event.workflow_run.head_branch }}
          path: apps/desktop/artifacts/linux/appimage/
          artifacts: Bitwarden-*-x86_64.AppImage
          name_is_regexp: true

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2t64 libfuse2 xvfb

      - name: Run AppImage
        working-directory: ${{ steps.download-appimage.outputs.download-path }}
        run: |
          chmod a+x ./*.AppImage
          xvfb-run -a ./*.AppImage --no-sandbox &
          sleep 30
          if pgrep bitwarden > /dev/null; then
            pkill -9 bitwarden
            echo "Bitwarden is running."
          else
            echo "Bitwarden is not running."
            exit 1
          fi

  linux-x64-flatpak:
    name: Install and run Linux x64 Flatpak
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_sha }}
          persist-credentials: false

      - name: Download flatpak artifact
        id: download-flatpak
        uses: bitwarden/gh-actions/download-artifacts@main
        with:
          workflow: build-desktop.yml
          workflow_conclusion: success
          branch: ${{ github.event.workflow_run.head_branch }}
          path: apps/desktop/artifacts/linux/flatpak/
          artifacts: com.bitwarden.desktop.flatpak

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2t64 flatpak xvfb
          flatpak install -y flathub

      - name: Install flatpak
        working-directory: ${{ steps.download-flatpak.outputs.download-path }}
        run: |
          flatpak install --bundle com.bitwarden.desktop.flatpak

      - name: Run Flatpak
        run: |
          xvfb-run -a flatpak run com.bitwarden.desktop &
          sleep 30
          if pgrep  bitwarden > /dev/null; then
            pkill -9 bitwarden
            echo "Bitwarden is running."
          else
            echo "Bitwarden is not running."
            exit 1
          fi

  linux-x64-snap:
    name: Install and run Linux x64 snap
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_sha }}
          persist-credentials: false

      - name: Download snap artifact
        id: download-snap
        uses: bitwarden/gh-actions/download-artifacts@main
        with:
          workflow: build-desktop.yml
          workflow_conclusion: success
          branch: ${{ github.event.workflow_run.head_branch }}
          path: apps/desktop/artifacts/linux/snap/
          artifacts: bitwarden_*_amd64.snap
          name_is_regexp: true

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2t64 snapd xvfb

      - name: Install snap
        working-directory: ${{ steps.download-snap.outputs.download-path }}
        run: |
          sudo snap install --dangerous ./bitwarden_*_amd64.snap

      - name: Run Snap
        run: |
          xvfb-run -a snap run bitwarden &
          sleep 30
          if pgrep bitwarden > /dev/null; then
            pkill -9 bitwarden
            echo "Bitwarden is running."
          else
            echo "Bitwarden is not running."
            exit 1
          fi
