# This workflow runs TypeScript compatibility checks when the SDK is updated.
# Triggered automatically by the SDK repository via repository_dispatch when SDK PRs are created/updated.
name: SDK Breaking Change Check
run-name: "SDK breaking change check (${{ github.event.client_payload.sdk_version }})"
on:
  repository_dispatch:
    types: [sdk-breaking-change-check]

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  type-check:
    name: TypeScript compatibility check
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    env:
      SOURCE_REPO: ${{ github.event.client_payload.source_repo }}
      SDK_VERSION: ${{ github.event.client_payload.sdk_version }}
      ARTIFACTS_RUN_ID: ${{ github.event.client_payload.artifacts_info.run_id }}
      ARTIFACT_NAME: ${{ github.event.client_payload.artifacts_info.artifact_name }}
      CLIENT_LABEL: ${{ github.event.client_payload.client_label }}
      
    steps:
      - name: Log in to Azure
        uses: bitwarden/gh-actions/azure-login@main
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}
      - name: Get Azure Key Vault secrets
        id: get-kv-secrets
        uses: bitwarden/gh-actions/get-keyvault-secrets@main
        with:
          keyvault: gh-org-bitwarden
          secrets: "BW-GHAPP-ID,BW-GHAPP-KEY"
      
      - name: Generate GH App token
        uses: actions/create-github-app-token@30bf6253fa41bdc8d1501d202ad15287582246b4 # v2.0.3
        id: app-token
        with:
          app-id: ${{ steps.get-kv-secrets.outputs.BW-GHAPP-ID }}
          private-key: ${{ steps.get-kv-secrets.outputs.BW-GHAPP-KEY }}
      - name: Log out from Azure
      - name: Validate inputs
        run: |
          echo "ðŸ” Validating required client_payload fields..."
          
          if [ -z "$SOURCE_REPO" ] || [ -z "$SDK_VERSION" ] || [ -z "$ARTIFACTS_RUN_ID" ] || [ -z "$ARTIFACT_NAME" ]; then
            echo "::error::Missing required client_payload fields"
            echo "SOURCE_REPO: $SOURCE_REPO"
            echo "SDK_VERSION: $SDK_VERSION"  
            echo "ARTIFACTS_RUN_ID: $ARTIFACTS_RUN_ID"
            echo "ARTIFACT_NAME: $ARTIFACT_NAME"
            echo "CLIENT_LABEL: $CLIENT_LABEL"
            exit 1
          fi
          
          echo "âœ… All required payload fields are present"
        uses: bitwarden/gh-actions/azure-logout@main
      - name: Check out clients repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get Node Version
        id: retrieve-node-version
        run: |
          NODE_NVMRC=$(cat .nvmrc)
          NODE_VERSION=${NODE_NVMRC/v/''}
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
          node-version: ${{ steps.retrieve-node-version.outputs.node_version }}

      - name: Install Node dependencies
        run: |
          echo "ðŸ“¦ Installing Node dependencies with retry logic..."
          
          RETRY_COUNT=0
          MAX_RETRIES=3
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ðŸ”„ npm ci attempt $RETRY_COUNT of $MAX_RETRIES..."
            
            if npm ci; then
              echo "âœ… npm ci successful"
              break
            else
              echo "âŒ npm ci attempt $RETRY_COUNT failed"
              [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 5
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ] && ! npm ci; then
            echo "::error::npm ci failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Download SDK artifacts
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸ“¥ Downloading SDK artifacts for $CLIENT_LABEL client from $SOURCE_REPO run $ARTIFACTS_RUN_ID..."
          
          # Download SDK artifacts with error handling
          if ! gh run download $ARTIFACTS_RUN_ID \
              --repo $SOURCE_REPO \
              --name $ARTIFACT_NAME \
              --dir ./temp-sdk-artifacts; then
            echo "::error::Failed to download SDK artifacts from run $ARTIFACTS_RUN_ID"
            echo "::error::Repository: $SOURCE_REPO, Artifact: $ARTIFACT_NAME"
            exit 1
          fi
          
          # Verify critical files exist
          if [ ! -f "./temp-sdk-artifacts/package.json" ]; then
            echo "::error::package.json not found in SDK artifacts"
            exit 1
          fi
          
          if [ ! -f "./temp-sdk-artifacts/bitwarden_wasm_internal.d.ts" ]; then
            echo "::error::TypeScript definitions not found in SDK artifacts"  
            exit 1
          fi

      - name: Install SDK locally and run type check
        run: |
          echo "ðŸ”§ Installing SDK artifacts locally..."
          echo "ðŸ“Š SDK Version: $SDK_VERSION"
          echo "ðŸ“¦ Artifact Source: $SOURCE_REPO run $ARTIFACTS_RUN_ID"
          
          # Create local package and install
          mkdir -p ./local-sdk-package
          cp -r ./temp-sdk-artifacts/* ./local-sdk-package/
          
          echo "ðŸ“‹ Local SDK package contents:"
          ls -la ./local-sdk-package/
          
          echo "ðŸ”— Installing local SDK package..."
          npm install ./local-sdk-package
          
          echo "ðŸ” Running TypeScript type checking for $CLIENT_LABEL client with SDK version: $SDK_VERSION"
          echo "ðŸŽ¯ Type checking command: npm run test:types"
          
          # Add GitHub Step Summary output
          echo "## ðŸ“Š TypeScript Compatibility Check ($CLIENT_LABEL)" >> $GITHUB_STEP_SUMMARY
          echo "- **Client**: $CLIENT_LABEL" >> $GITHUB_STEP_SUMMARY
          echo "- **SDK Version**: $SDK_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Repository**: $SOURCE_REPO" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Run ID**: $ARTIFACTS_RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TYPE_CHECK_START=$(date +%s)
          
          # Run type check with timeout - exit code determines gh run watch result
          if timeout 10m npm run test:types; then
            TYPE_CHECK_END=$(date +%s)
            TYPE_CHECK_DURATION=$((TYPE_CHECK_END - TYPE_CHECK_START))
            echo "âœ… TypeScript compilation successful for $CLIENT_LABEL client (${TYPE_CHECK_DURATION}s)"
            echo "âœ… **Result**: TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
            echo "No breaking changes detected in $CLIENT_LABEL client for SDK version $SDK_VERSION" >> $GITHUB_STEP_SUMMARY
          else
            TYPE_CHECK_END=$(date +%s)
            TYPE_CHECK_DURATION=$((TYPE_CHECK_END - TYPE_CHECK_START))
            echo "âŒ TypeScript compilation failed for $CLIENT_LABEL client after ${TYPE_CHECK_DURATION}s - breaking changes detected"
            echo "âŒ **Result**: TypeScript compilation failed" >> $GITHUB_STEP_SUMMARY
            echo "Breaking changes detected in $CLIENT_LABEL client for SDK version $SDK_VERSION" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Cleanup temporary directories
          echo "ðŸ§¹ Cleaning up temporary directories..."
          rm -rf ./temp-sdk-artifacts ./local-sdk-package