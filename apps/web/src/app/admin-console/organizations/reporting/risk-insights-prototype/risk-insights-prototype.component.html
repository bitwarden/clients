<app-header></app-header>

<div class="tw-min-h-screen tw-flex tw-flex-col">
  <div class="tw-mb-4">
    <p class="tw-text-main tw-max-w-4xl">
      {{ "riskInsightsPrototypeDesc" | i18n }}
    </p>
  </div>

  <!-- Controls Section -->
  <div class="tw-p-4 tw-bg-background-alt tw-rounded-lg tw-mb-4">
    <div class="tw-flex tw-flex-wrap tw-items-center tw-gap-6 tw-mb-4">
      <!-- Weak Password Checkbox -->
      <label class="tw-flex tw-items-center tw-gap-2 tw-cursor-pointer">
        <input
          type="checkbox"
          bitCheckbox
          [checked]="enableWeakPassword()"
          (change)="toggleWeakPassword()"
          [disabled]="isProcessing()"
        />
        <span class="tw-text-main">{{ "enableWeakPasswordCheck" | i18n }}</span>
      </label>

      <!-- HIBP Checkbox -->
      <label class="tw-flex tw-items-center tw-gap-2 tw-cursor-pointer">
        <input
          type="checkbox"
          bitCheckbox
          [checked]="enableHibp()"
          (change)="toggleHibp()"
          [disabled]="isProcessing()"
        />
        <span class="tw-text-main">{{ "enableHibpCheck" | i18n }}</span>
      </label>

      <!-- Reused Password Checkbox -->
      <label class="tw-flex tw-items-center tw-gap-2 tw-cursor-pointer">
        <input
          type="checkbox"
          bitCheckbox
          [checked]="enableReusedPassword()"
          (change)="toggleReusedPassword()"
          [disabled]="isProcessing()"
        />
        <span class="tw-text-main">{{ "enableReusedPasswordCheck" | i18n }}</span>
      </label>
    </div>

    <!-- Run Report Button -->
    <button
      type="button"
      bitButton
      buttonType="primary"
      (click)="runReport()"
      [disabled]="isProcessing()"
    >
      @if (isProcessing()) {
        <i class="bwi bwi-spinner bwi-spin tw-mr-2" aria-hidden="true"></i>
        {{ "processing" | i18n }}
      } @else {
        <i class="bwi bwi-play tw-mr-2" aria-hidden="true"></i>
        {{ "runReport" | i18n }}
      }
    </button>
  </div>

  <!-- Progress Section -->
  @if (showProgress()) {
    <div class="tw-p-4 tw-bg-background-alt tw-rounded-lg tw-mb-4">
      <!-- Main Progress -->
      <div class="tw-mb-4">
        <div class="tw-flex tw-justify-between tw-text-sm tw-mb-1">
          <span class="tw-text-muted">{{ progressMessage() || "Processing..." }}</span>
          <span class="tw-text-muted">{{ getOverallProgress() | number: "1.0-0" }}%</span>
        </div>
        <bit-progress [barWidth]="getOverallProgress()" bgColor="primary"></bit-progress>
      </div>

      <!-- HIBP Progress (only when HIBP is enabled and running) -->
      @if (enableHibp() && processingPhase() === ProcessingPhase.RunningHibp) {
        <div>
          <div class="tw-flex tw-justify-between tw-text-sm tw-mb-1">
            <span class="tw-text-muted">
              {{ "checkingExposedPasswords" | i18n }}: {{ hibpProgress().current }} /
              {{ hibpProgress().total }}
            </span>
            <span class="tw-text-muted">{{ hibpProgress().percent }}%</span>
          </div>
          <bit-progress [barWidth]="hibpProgress().percent" bgColor="warning"></bit-progress>
        </div>
      }

      <!-- Completion Status -->
      @if (processingPhase() === ProcessingPhase.Complete) {
        <div class="tw-flex tw-items-center tw-gap-2 tw-text-success-600">
          <i class="bwi bwi-check-circle" aria-hidden="true"></i>
          <span>{{ "reportComplete" | i18n }}</span>
        </div>
      }

      <!-- Error Status -->
      @if (processingPhase() === ProcessingPhase.Error && error()) {
        <div class="tw-flex tw-items-center tw-gap-2 tw-text-danger-600">
          <i class="bwi bwi-error" aria-hidden="true"></i>
          <span>{{ error() }}</span>
        </div>
      }
    </div>
  }

  <div class="tw-flex-1 tw-flex tw-flex-col">
    <bit-tab-group [(selectedIndex)]="tabIndex" (selectedIndexChange)="onTabChange($event)">
      <bit-tab [label]="'items' | i18n">
        @if (initialized()) {
          <app-risk-insights-prototype-items></app-risk-insights-prototype-items>
        }
      </bit-tab>
      <bit-tab [label]="'applications' | i18n">
        @if (initialized()) {
          <app-risk-insights-prototype-applications></app-risk-insights-prototype-applications>
        }
      </bit-tab>
      <bit-tab [label]="'members' | i18n">
        @if (initialized()) {
          <app-risk-insights-prototype-members></app-risk-insights-prototype-members>
        }
      </bit-tab>
    </bit-tab-group>
  </div>
</div>
